services:
  kafka:
    image: bitnamilegacy/kafka:4.0.0-debian-12-r10
    container_name: kafka
    environment:
      # --- REQUIRED: enable KRaft ---
      - KAFKA_ENABLE_KRAFT=yes

      # --- KRaft configuration ---
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093

      # --- Listeners ---
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT

      # --- Dev-friendly defaults ---
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=false
      - KAFKA_CFG_NUM_PARTITIONS=3
      - KAFKA_CFG_LOG_RETENTION_MS=${KAFKA_RETENTION_MS:-604800000}
      - KAFKA_CFG_LOG_RETENTION_CHECK_INTERVAL_MS=300000
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_CFG_GROUP_INITIAL_REBALANCE_DELAY_MS=0

    ports:
      - "9092:9092"

    volumes:
      - kafka_data:/bitnami/kafka

    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1"
        ]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 10s

  kafka-init:
    image: bitnamilegacy/kafka:4.0.0-debian-12-r10
    container_name: kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint:
      - bash
      - -c
      - |
        echo "Creating Kafka topics..."
        kafka-topics.sh \
          --bootstrap-server kafka:9092 \
          --create \
          --if-not-exists \
          --topic last.alerts.raw \
          --partitions 3 \
          --replication-factor 1
        echo "Kafka topics ready."

  publisher:
    build:
      context: ./publisher
      network: host
    container_name: publisher
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    environment:
      - BOOTSTRAP_SERVERS=${BOOTSTRAP_SERVERS:-kafka:9092}
      - TOPIC=${TOPIC:-last.alerts.raw}
      - INPUT_DIR=/input
      - ARCHIVE_DIR=/archive
      - STATE_DB=/state/state.db
      - POLL_SECONDS=${POLL_SECONDS:-2}
      - PUBLISH_MODE=${PUBLISH_MODE:-live}
      - CUTOFF_DAYS=${CUTOFF_DAYS:-}
      - CUTOUT_BASE_URL=${CUTOUT_BASE_URL:-}
    volumes:
      - ${INPUT_DIR_HOST}:/input:ro
      - ./archive:/archive
      - ./state:/state
    restart: unless-stopped

  consumer:
    build:
      context: ./consumer
      network: host
    container_name: consumer
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    environment:
      - BOOTSTRAP_SERVERS=${BOOTSTRAP_SERVERS:-kafka:9092}
      - TOPIC=${TOPIC:-last.alerts.raw}
      - GROUP_ID=example-consumer
      - AUTO_OFFSET_RESET=latest
    restart: unless-stopped

volumes:
  kafka_data:
